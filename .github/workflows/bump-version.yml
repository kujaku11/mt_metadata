name: Bump Version on Release Label

on:
  pull_request:
    types: [labeled]
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  bump-version:
    # Run only when a release label is added to an open PR
    if: |
      github.event.pull_request.state == 'open' && (
        github.event.label.name == 'release:major' ||
        github.event.label.name == 'release:minor' ||
        github.event.label.name == 'release:patch'
      )
    runs-on: ubuntu-latest

    steps:
      - name: Check out PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install tools
        run: |
          pip install bump-my-version pandoc
          sudo apt-get update
          sudo apt-get install -y pandoc
          cargo install git-cliff

      - name: Set up Git user
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Determine version bump type
        id: bump
        run: |
          if [[ "${{ github.event.label.name }}" == "release:major" ]]; then
            echo "type=major" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.label.name }}" == "release:minor" ]]; then
            echo "type=minor" >> $GITHUB_OUTPUT
          else
            echo "type=patch" >> $GITHUB_OUTPUT
          fi

      - name: Bump version
        run: bump-my-version bump ${{ steps.bump.outputs.type }}
        env:
          BMV_ALLOW_DIRTY: "true"

      - name: Extract version
        id: version
        run: |
          VERSION=$(bump-my-version show current)
          echo "Extracted version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate changelog
        run: |
          git cliff --unreleased --tag v${{ steps.version.outputs.version }} -o CHANGELOG.md
          echo "Generated changelog for version ${{ steps.version.outputs.version }}"

      - name: Update HISTORY.rst
        run: |
          # Convert CHANGELOG.md to rst and prepend to HISTORY.rst
          if [ -f CHANGELOG.md ]; then
            pandoc CHANGELOG.md -f markdown -t rst -o CHANGELOG.rst
            # Prepend new changelog to HISTORY.rst
            if [ -f HISTORY.rst ]; then
              cat CHANGELOG.rst HISTORY.rst > HISTORY_temp.rst
              mv HISTORY_temp.rst HISTORY.rst
              echo "Updated HISTORY.rst with version ${{ steps.version.outputs.version }}"
            else
              mv CHANGELOG.rst HISTORY.rst
              echo "Created HISTORY.rst"
            fi
          fi

      - name: Commit and push changes to PR branch
        run: |
          git add .
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }} and update changelog [skip ci]" || echo "No changes to commit"
          git push origin HEAD:${{ github.head_ref }}

      - name: Add comment to PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸš€ Version bumped to **v${{ steps.version.outputs.version }}** and changelog updated. Ready to merge!'
            })
